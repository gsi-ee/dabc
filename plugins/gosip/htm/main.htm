<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html;
      charset=windows-1252">
    <title>GOSIP user interface</title>
    <link rel="stylesheet" type="text/css"
      href="/jsrootiosys/style/jquery-ui.css">
    <script src="/jsrootiosys/scripts/jquery.js" type="text/javascript"></script>
    <script src="/jsrootiosys/scripts/jquery-ui.js" type="text/javascript"></script>
    <script src="gosip.js" type="text/javascript"></script>
    <style type="text/css">
    
      body
		{ 
			position:absolute;
			background:#ffffff;
		}
		html, body
		{ 
			top:0; left:0; right:0;
			min-height:100%;
			margin:0;
			padding:0;
			width:100%;
		}
		#header_container 
		{
			position:fixed;
			top:0; left:0; right:0;
			text-align:center;
			margin:0;
			height:3em;
			z-index:3;
		}
		.DacEdit {
		   width: 90%;
		} 

		#header 
		{
			position:absolute;
			top:0; left:0; right:0; bottom:0;
			height:100%;
			z-index:3;
			margin:0;
			padding:0.2em;
		}
		
		#content
		{
			margin:0;
			padding-top:4.85em;
			padding-left:0.5em;
			padding-right:0.5em;
			padding-bottom:3em;
			z-index:2;
		}
		#footer_container
		{
			position:fixed;
			bottom:0; left:0; right:0;
			text-align:center;
			margin:0;
			height:3em;
			z-index:3;
		}
		#footer 
		{
			position:absolute;
			top:0; left:0; right:0; bottom:0;
			z-index:3;
		}
		
		/* Nun für den MSIE */
		* html, * html body 
		{
			overflow:hidden;
			bottom:0;
			height:100%;
		}
		* html #header_container, * html #footer_container
		{
			position:absolute;
			width:100%;
			padding-right:16px;
		}
		* html #menu
		{
			position:absolute;
		}
		* html #header,* html #footer
		{
			height:100%;
			position:static;
		}
		* html #content 
		{
			position:absolute;
			top:0; bottom:0; left:0; right:0;
			height:100%;
			width:100%;
			overflow:auto;
			margin:0;
		}
    
		#left_col {
		   float:left;
		   width: 80%;
		}
		#right_col {
		   float:right;
		   width: 20%;
		}
		#tabs {
		   float:bottom;
		   height: 100%;
		}
      
      label {
        vertical-align: top;
      }
		</style>
		
      <script type="text/javascript">
   
      function ExecCommand() {
         //console.log("Execute");
         
         var elem = document.getElementById("status_message");
         
         var xmlHttp = new XMLHttpRequest();
         
         var cmdtext = '../CmdGosip/execute?sfp=' + $("#id_sfp").val() + '&dev='+$("#id_dev").val();
         
         cmdtext+="&cmd='[\"-r 0x876\",\"-r 0x176\",\"-w 0x564 0x234\"]'";
         
         elem.innerHTML = "Executing command ...";
         
         xmlHttp.open('GET', cmdtext, true);
         
         xmlHttp.onreadystatechange = function () {
            // console.log("onready change " + xmlHttp.readyState); 
            if (xmlHttp.readyState == 4) {
               var reply = JSON.parse(xmlHttp.responseText);
            
               if (reply)
                  elem.innerHTML = "Result = " + reply["_Result_"];
               else
                  elem.innerHTML = "command fail";
            }
         };
         
         xmlHttp.send(null);
      }
      
      function ButtonAction() {
         console.log("sfp = " + $("#id_sfp").val() + "  dev = " + $("#id_dev").val() 
                      + " active = " + $("#tabs").tabs("option","active"));
      }

      var Setup;
      
      function ReadSlave() {
         if (document.getElementById("broadcast").checked) {
           Setup.fSFP = -1;
           Setup.fDEV = -1;
         } else {
           Setup.fSFP = $("#id_sfp").val();
           Setup.fDEV = $("#id_dev").val();
         }
         Setup.fLogging = document.getElementById("Verbose").checked;         
      }
      
      function SetStatusMessage(info)
      {
         var d = new Date();
         var txt = d.toLocaleTimeString() + " SFP:" + Setup.fSFP + " DEV:"+Setup.fDEV + "  " + info;
         document.getElementById("status_message").innerHTML = txt; 
      }
      
      function RefreshView(res) {
      
         SetStatusMessage("Reading registers " + (res ? "OK" : "Fail"));
         
         if (Setup.fLogData!=null) {
            var ddd = "";
            // console.log("log length = " + Setup.fLogData.length); 
            for (var i in Setup.fLogData) {
               ddd += "<pre>";
               ddd += Setup.fLogData[i];
               ddd += "</pre>";
            }
            
            document.getElementById("logging").innerHTML += ddd;
                
            Setup.fLogData = null;
         }

         if (!res) return;
         
         var base = document.getElementById("HexMode").checked ? 16 : 10;
         
         Setup.RefreshQFW(base);
         
         Setup.RefreshDAC(base);
         
         Setup.RefreshCounters(base);
      }
      
      function CompleteCommand(res) {
         
         SetStatusMessage("Writing registers " + (res ? "OK" : "Fail"));
         
         if (Setup.fLogData!=null) {
            var ddd = "";
            //console.log("log length = " + Setup.fLogData.length); 
            for (var i in Setup.fLogData) {
               ddd += "<pre>";
               ddd += Setup.fLogData[i];
               ddd += "</pre>";
            }
            
            document.getElementById("logging").innerHTML += ddd;
            Setup.fLogData = null;
         }
      }
      
      $(function() {

         Setup = new PolandSetup("../CmdGosip/execute");
      
         $("#tabs").tabs();
         $("#id_sfp").selectmenu();
         $("#id_dev").selectmenu();
         
         $( "#broadcast" ).button();
         
         $("#buttonScanOffset").button().click(function() { ButtonAction(); }); 
         $("#buttonInitChain").button().click(function() { ButtonAction(); }); 
         $("#buttonReset").button().click(function() { ButtonAction(); }); 
         $("#buttonResetPEX").button().click(function() { ButtonAction(); });
         
         $("#DacModeCombo").selectmenu({
            change: function( event, ui ) { Setup.fDACMode = ui.item.value; Setup.RefreshDAC(); }
         });
         
         if ($("#DacModeCombo").selectmenu("option","width") < 500)
            $("#DacModeCombo").selectmenu("option","width", 500);

         $("#QFWModeCombo").selectmenu( {
            change: function( event, ui ) { Setup.fQFWMode = ui.item.value; }
         });
         if ($("#QFWModeCombo").selectmenu("option","width") < 500)
            $("#QFWModeCombo").selectmenu("option","width", 500);
          
         $("#buttonShow").button().click(function() { 
            ReadSlave(); 
            SetStatusMessage("Start register reading...");
            Setup.ReadRegisters(RefreshView); 
         });
          
         $("#buttonApply").button().click(function() {
            ReadSlave();

            Setup.EvaluateDAC();
            Setup.EvaluateQFW();
            
            var cmd = ($("#tabs").tabs("option","active")==0) ? "QFW" : "DAC";   
            
            SetStatusMessage("Start writing "+cmd);
            Setup.SetRegisters(cmd, CompleteCommand);
         });
          
         $("#buttonConfigure").button().click(function() { ButtonAction(); }); 
         $("#buttonDataDump").button().click(function() { ButtonAction(); }); 
         $("#buttonClear").button().click(function() {
            document.getElementById("logging").innerHTML = 
              "<br>GOSIP web interface v 0.1, 25 Jul 2014<br> S.Linev/J.Adamzewski-Musch<br>";
         }); 
       });
       
       function initGUI() {
          var base = document.getElementById("HexMode").checked ? 16 : 10;
          Setup.RefreshQFW(base);
          Setup.RefreshDAC(base);
          Setup.RefreshCounters(base);
          $("#buttonClear").button().click();
       } 
       
       $(document).ready(initGUI);
      
   </script>
  </head>
  <body>
    <div id="header_container">
      <table style="width: 100%">
        <tbody>
          <tr>
            <td> <label for="id_sfp">SFP</label>
              <select name="name_id_sfp" id="id_sfp">
                <option selected="selected">0</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
              </select>
            </td>
            <td> <label for="id_dev">DEV</label>
              <select name="name_id_dev" id="id_dev">
                <option selected="selected">0</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
              </select>
            </td>
            <td> <input id="broadcast" type="checkbox"><label for="broadcast">All Devs</label> </td>
            <td>  </td>
            <td> <button id="buttonScanOffset">ScanOffset</button> </td>
            <td> <button id="buttonInitChain">InitChain</button> </td>
            <td> <button id="buttonReset">Reset</button> </td>
            <td> <button id="buttonResetPEX">Reset PEX</button> </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div id="content">
      <div id="left_col">
        <h3 id="status_message">Status message</h3>
        <div id="tabs">
          <ul>
            <li><a href="#tabs-1">QFW</a></li>
            <li><a href="#tabs-2">DAC</a></li>
          </ul>
          <div id="tabs-1">
            <table style="width: 100%">
              <tbody>
                <tr>
                  <td> <input id="MasterTrigger" type="checkbox"><label for="MasterTrigger">Trigger Master</label>  </td>
                  <td> <input id="InternalTrigger" type="checkbox"><label for="InternalTrigger">Internal Trigger</label> </td>
                  <td> <input id="FESAMode" type="checkbox"><label for="FESAMode">FESA Mode</label> </td>
                </tr>
              </tbody>
            </table>
            <select name="QFWModeCombo" id="QFWModeCombo" style="width: 100%">
              <option selected="selected" value="0">(-) [ 2.5pF & 0.25pC]</option>
              <option value="1">(-) [25.0pF & 2.50pC]</option>
              <option value="2">(+) [ 2.5pF & 0.25pC]</option>
              <option value="3">(+) [25.0pF & 2.50pC]</option>
              <option value="16">1000uA (-) [ 2.5pF & 0.25pC]</option>
              <option value="17">1000uA (-) [25.0pF & 2.50pC]</option>
              <option value="18">1000uA (+) [ 2.5pF & 0.25pC]</option>
              <option value="19">1000uA (+) [25.0pF & 2.50pC]</option>
            </select>
            <table style="width: 100%">
              <tbody>
                <tr>
                  <td> </td>
                  <td nowrap> Step </td>
                  <td nowrap> Time per Step [mus] </td>
                </tr>
                <tr>
                  <td nowrap> Time slice 1 </td>
                  <td> <input class="DacEdit" id="TS1Loop" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="TS1Time" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td nowrap> Time slice 2 </td>
                  <td> <input class="DacEdit" id="TS2Loop" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="TS2Time" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td nowrap> Time slice 3 </td>
                  <td> <input class="DacEdit" id="TS3Loop" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="TS3Time" value="0" type="text"> </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="tabs-2">
            <select name="DacModeCombo" id="DacModeCombo">
              <option selected="selected" value="1">Set Manually (mode 1)</option>
              <option value="2">Test Structure (mode 2)</option>
              <option value="3">Calibrate (mode 3)</option>
              <option value="4">All Constant (mode 4)</option>
            </select>
            <table style="width: 100%">
              <tbody>
                <tr>
                  <td nowrap> Value </td>
                  <td nowrap> Offset </td>
                  <td nowrap> Offset Delta </td>
                  <td nowrap> Cal. time (ms) </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacStart" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacOffset" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacDeltaOffset" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacCalibTime" value="0" type="text"> </td>
                </tr>
                <tr> </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit1" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit2" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit3" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit4" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit5" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit6" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit7" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit8" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit9" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit10" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit11" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit12" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit13" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit14" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit15" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit16" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit17" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit18" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit19" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit20" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit21" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit22" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit23" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit24" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit25" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit26" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit27" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit28" value="0" type="text"> </td>
                </tr>
                <tr>
                  <td> <input class="DacEdit" id="DacEdit29" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit30" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit31" value="0" type="text"> </td>
                  <td> <input class="DacEdit" id="DacEdit32" value="0" type="text"> </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div id="logging" style="width: 100%; height: 300px; overflow-y: auto;">
        </div>
      </div>
      <div id="right_col">
        <h3>QFW Counters</h3>
        <h2>Trigger</h2>
        <div align="center" id="TriggerLbl" style="width: 100%"> </div>
        <br>
        <h2>Errors</h2>
        <div align="center" id="ErrorsLbl" style="width: 100%"> </div>
        <br>
        <input id="HexMode" type="checkbox"><label for="HexMode">Hexmode</label><br>
        <input id="Verbose" type="checkbox"><label for="Verbose">Verbose</label><br>
      </div>
      
    </div>
    <div id="footer_container">
      <table style="width: 100%">
        <tbody>
          <tr>
            <td> <button id="buttonShow">Show</button> </td>
            <td> <button id="buttonApply">Apply</button> </td>
            <td> <button id="buttonConfigure">Configure</button> </td>
            <td> <br>
            </td>
            <td> <button id="buttonDataDump">DataDump</button> </td>
            <td> <button id="buttonClear">Clear</button> </td>
          </tr>
        </tbody>
      </table>
    </div>
  </body>
</html>
