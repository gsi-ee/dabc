<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

   <meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>
   <title>DABC node hierarchy</title>
   
   <link rel="stylesheet" href="httpsys/files/jquery.treeview.css" />
   <link rel="stylesheet" href="httpsys/files/screen.css" />
   
   <script src="httpsys/scripts/jquery.js" type="text/javascript"></script>
   <script src="httpsys/scripts/jquery.cookie.js" type="text/javascript"></script>
   <script src="httpsys/scripts/jquery.treeview.js" type="text/javascript"></script>
   <script src="httpsys/scripts/jquery.treeview.edit.js" type="text/javascript"></script>
   <script src="httpsys/scripts/jquery.treeview.async.js" type="text/javascript"></script>
   <script src="httpsys/scripts/raphael.2.1.0.min.js" type="text/javascript" ></script>
   <script src="httpsys/scripts/justgage.1.0.1.min.js" type="text/javascript" ></script>
   
   <script type='text/javascript'>

      DABC = {};

      DABC.version = "2.1.1";
      
      DABC.mgr = 0;

      DABC.DrawElement = function(_item) {
         this.itemname = _item;   // full item name in hierarhcy
         this.frameid = "";       // id of top frame, where item is drawn
         return this;
      }
      
      DABC.DrawElement.prototype.CreateFrames = function(topid,cnt) {
         this.frameid = "dabc_dummy_" + cnt;
      
         var entryInfo = 
           "<div id='" +this.frameid + "'>" + 
            "<h2> CreateFrames for item " + this.itemname + " not implemented </h2>"+
           "</div>"; 
         $(topid).append(entryInfo);
      }
      
      DABC.DrawElement.prototype.SetValue = function(val) {
         document.getElementById(this.frameid).innerHTML = "Value = " + val;
      }

      // ======== end of DrawElement ======================

      // ======== start of GaugeDrawElement ======================
      
      DABC.GaugeDrawElement = function(val) {
         DABC.DrawElement.call(this, val);
         this.gauge = 0;
      }
      
      // TODO: check how it works in different older browsers
      DABC.GaugeDrawElement.prototype = Object.create( DABC.DrawElement.prototype );


      DABC.GaugeDrawElement.prototype.CreateFrames = function(topid, id) {

         this.frameid = "dabc_gauge_" + id;

         var entryInfo = 
           "<div id='"+this.frameid+ "' class='200x160px'> </div> \n";
         $(topid).append(entryInfo);

         this.gauge = new JustGage({
             id: this.frameid, 
             value: 67,
             min: 0,
             max: 100,
             title: this.itemname
         }); 
      }

      DABC.GaugeDrawElement.prototype.SetValue = function(val) {
         this.gauge.refresh(val);
      }

      
      // ======== end of GaugeDrawElement ======================


      // ======== start of RootDrawElement ======================
      
      DABC.RootDrawElement = function(val) {
         DABC.DrawElement.call(this, val);
      
         this.rootobj = 0; 
      }
      
      
      // TODO: check how it works in different older browsers
      DABC.RootDrawElement.prototype = Object.create( DABC.DrawElement.prototype );
      
      // ======== end of RootDrawElement ======================

      
      
      // ============= start of DABC.Manager =============== 
   
      DABC.Manager = function(abc) {
         this.cnt = 0;            // counter to create new element 
         this.arr = new Array();  // array of DrawElement
         return this;
      }
      
      DABC.Manager.prototype.FindItem = function(_item) {
         for (var i in this.arr) {
            if (this.arr[i].itemname == _item) return this.arr[i];
         }
      }

      DABC.Manager.prototype.empty = function() {
         return this.arr.length == 0;
      }
      
      DABC.Manager.prototype.Draw = function(_item) {
         if (!_item) return;
      
         if (this.FindItem(_item)) return;
         
         //var elem = new DABC.DrawElement(_item);
         
         var elem = new DABC.RootDrawElement(_item);
         
         elem.CreateFrames("#report", this.cnt++);
         
         this.arr.push(elem);
      }

      DABC.Manager.prototype.GetRequestUrl = function() {
         if (!this.arr.length) return;
      
         var args = "chartreq.htm?";
          
         for (var i in this.arr) {
            if (i>0) args+="&";
            args += this.arr[i].itemname;
         }
         
         return args;
      }
      
      DABC.Manager.prototype.NewRequest = function() {
        var req;
        // For Safari, Firefox, and other non-MS browsers
        if (window.XMLHttpRequest) {
          try {
            req = new XMLHttpRequest();
          } catch (e) {
            req = false;
          }
        } else if (window.ActiveXObject) {
          // For Internet Explorer on Windows
          try {
            req = new ActiveXObject("Msxml2.XMLHTTP");
          } catch (e) {
            try {
              req = new ActiveXObject("Microsoft.XMLHTTP");
            } catch (e) {
              req = false;
            }
          }
        }
        
        return req;
      }
      
      DABC.Manager.prototype.UpdateAll = function() {

         var url = this.GetRequestUrl();
         if (!url) return;
     
         var req = this.NewRequest();
         if (!req) return;

         // $("#report").append("<br> Send request " + url);

         req.open("POST", url, false);
         req.send();
          
         var repl = JSON && JSON.parse(req.responseText) || $.parseJSON(req.responseText);

         // $("#report").append("<br> Get reply " + req.responseText);

         req = 0;
         if (!repl) return;

         for (var indx in repl) {
            var elem = this.FindItem(repl[indx].name);
            // $("#report").append("<br> Check reply for " + repl[indx].name);

            if (elem) elem.SetValue(repl[indx].value);
         }
      }
      
      DABC.Manager.prototype.click = function(item) {
         var itemname = item.getAttribute("fullname");
         
         if (this.FindItem(itemname)) return;
         
         var kind = item.getAttribute("kind");

         var elem = 0;
         
         if (kind == "rate") {
           elem = new DABC.GaugeDrawElement(itemname);
         } else
         if (kind.indexOf("ROOT.") == 0) {
            elem = new DABC.RootDrawElement(itemname);
         }
         
         if (elem==0) return;
         
         elem.CreateFrames("#report", this.cnt++);
         
         this.arr.push(elem);
      }
      
      
      
      // ============= end of DABC.Manager =============== 
   
      function initGUI() {
         if (!DABC.mgr) DABC.mgr = new DABC.Manager();
      
         $("#black").treeview( {
            url: "nodetopology.txt",
            control: "#treecontrol",
            persist: "cookie",
            cookieId: "treeview-black"
         });
         
         setInterval(function() { DABC.mgr.UpdateAll(); }, 3000);
      }
      
      $(document).ready(initGUI);
      
   </script>
   
</head>

<body>
   
   <div id="overlay"><font face="Verdana" size="1px">DABC version 2.1</font></div>
   
   <div id="main" class="column" style="width:300px;float:left;">
   
      <a href="/">Main page</a><br><br>
   
      <h1><font face="Verdana" size="4">DABC node hierarchy</font></h1>
      
      <div id="treecontrol">
         <a title="Collapse the entire tree below" href="#"><img src="httpsys/images/minus.gif" /> Collapse All</a>
         <a title="Expand the entire tree below" href="#"><img src="httpsys/images/plus.gif" /> Expand All</a>
         <a title="Toggle the tree below, opening closed branches, closing open branches" href="#">Toggle All</a>
      </div>
      <div id="status">
          <ul id="black" class="treeview-black">
          </ul>
      </div>
      
  </div>

  <div id="reportHolder" class="column" style="width:500px;float:left;">
     <div id="report"> </div>
  </div>
  
</body>
</html>

