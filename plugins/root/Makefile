include $(DABCSYS)/config/Makefile.config

ifdef DABC_ISROOT


ifdef DABCMAINMAKE
DABCROOTDIR = plugins/root
else
DABCROOTDIR = .
endif

DABCROOTDIRI      = $(DABCROOTDIR)/root
DABCROOTDIRS      = $(DABCROOTDIR)/src
DABCROOTDIRSNIFF  = $(DABCROOTDIR)/sniffer

DABCROOT_LINKDEF  = $(DABCROOTDIR)/LinkDef.h

DABCROOT_LIBNAME  = $(LIB_PREFIX)DabcRoot
DABCROOT_LIB      = $(TGTDLLPATH)/$(DABCROOT_LIBNAME).$(DllSuf)
DABCROOT_MAP      = $(TGTDLLPATH)/$(DABCROOT_LIBNAME).rootmap

DABCROOT_DICTINCL = $(DABCROOTDIR)/DabcRoot.h \
                    $(DABCROOTDIRI)/TDabcEngine.h
                    
DABCROOT_LIBDEP   = $(TGTDLLPATH)/libDabcHttp.$(DllSuf) \
                    $(TGTDLLPATH)/libDabcBase.$(DllSuf)

## must be similar for every module

DABCROOT_H        = $(wildcard $(DABCROOTDIRI)/*.$(HedSuf))
DABCROOT_S        = $(wildcard $(DABCROOTDIRS)/*.$(SrcSuf))
DABCROOT_O        = $(patsubst %.$(SrcSuf), $(BLD_DIR)/%.$(ObjSuf), $(DABCROOT_S))
DABCROOT_D        = $(patsubst %.$(SrcSuf), $(BLD_DIR)/%.$(DepSuf), $(DABCROOT_S))

DABCROOT_DICT      = $(BLD_DIR)/$(DABCROOTDIR)/G__DABCROOT
DABCROOT_DH        = $(DABCROOT_DICT).$(HedSuf)
DABCROOT_DS        = $(DABCROOT_DICT).$(SrcSuf)
DABCROOT_DO        = $(DABCROOT_DICT).$(ObjSuf) 
DABCROOT_DD        = $(DABCROOT_DICT).$(DepSuf)

# used in the main Makefile

ALLHDRS          += $(patsubst $(DABCROOTDIR)/%.h, $(DABCINCPATH)/%.h, $(DABCROOT_H))
ALLHDRS          += $(patsubst $(DABCROOTDIR)/%.h, $(DABCINCPATH)/%.h, $(DABCROOT_DICTINCL)) 
ALLDEPENDENC     += $(DABCROOT_D) $(DABCROOT_DD) 


ifeq ($(DABC_ROOT_RHHTP), false)

DABCROOT_SNIFF_H  = $(wildcard $(DABCROOTDIRSNIFF)/*.$(HedSuf))
DABCROOT_SNIFF_S  = $(wildcard $(DABCROOTDIRSNIFF)/*.$(SrcSuf))
DABCROOT_SNIFF_O  = $(patsubst %.$(SrcSuf), $(BLD_DIR)/%.$(ObjSuf), $(DABCROOT_SNIFF_S))
DABCROOT_SNIFF_D  = $(patsubst %.$(SrcSuf), $(BLD_DIR)/%.$(DepSuf), $(DABCROOT_SNIFF_S))

DABCROOT_SNIFF_LINKDEF  = $(DABCROOTDIR)/SnifferLinkDef.h

DABCROOT_SNIFF_DICT = $(BLD_DIR)/$(DABCROOTDIR)/G__DABCROOTSNIFF
DABCROOT_SNIFF_DH   = $(DABCROOT_SNIFF_DICT).$(HedSuf)
DABCROOT_SNIFF_DS   = $(DABCROOT_SNIFF_DICT).$(SrcSuf)
DABCROOT_SNIFF_DO   = $(DABCROOT_SNIFF_DICT).$(ObjSuf) 
DABCROOT_SNIFF_DD   = $(DABCROOT_SNIFF_DICT).$(DepSuf)


ALLHDRS            += $(patsubst $(DABCROOTDIRSNIFF)/%.h, $(DABCINCPATH)/%.h, $(DABCROOT_SNIFF_H)) 
DABCROOT_D         += $(DABCROOT_SNIFF_D) 
DABCROOT_O         += $(DABCROOT_SNIFF_O) 
DABCROOT_DO        += $(DABCROOT_SNIFF_DO) 
DABCROOT_DD        += $(DABCROOT_SNIFF_DD) 

ifdef DABC_FASTCGI
HTTPINCDIR += $(DABC_FASTCGI_INC)
HTTPLIBEXTRA += $(DABC_FASTCGI_LIB)
else
HTTPDEFEXTRA += HTTP_WITHOUT_FASTCGI
endif

ifeq ($(DABC_ROOT_ASIMAGE),true)
DABCROOT_LIBDEP += $(DABC_ROOTLIBDIR)/libASImage.$(DllSuf)
else
HTTPDEFEXTRA += HTTP_WITHOUT_ASIMAGE
endif

HTTPDEFEXTRA += COMPILED_WITH_DABC

HTTPINCDIR += $(DABCROOTDIR)/../http/civetweb

DABCROOT_LIBDEP += $(DABC_ROOTLIBDIR)/libThread.$(DllSuf) \
                   $(DABC_ROOTLIBDIR)/libTree.$(DllSuf) \
                   $(DABC_ROOTLIBDIR)/libHist.$(DllSuf) \
                   $(DABC_ROOTLIBDIR)/libGpad.$(DllSuf) \
                   $(DABC_ROOTLIBDIR)/libGraf.$(DllSuf) \
                   $(DABC_ROOTLIBDIR)/libRIO.$(DllSuf)

$(DABCROOT_SNIFF_DS): INCLUDES += $(DABCROOTDIRI)

$(DABCROOT_SNIFF_O) $(DABCROOT_SNIFF_D) $(DABCROOT_SNIFF_DO) $(DABCROOT_SNIFF_DD): INCLUDES += $(HTTPINCDIR) 

$(DABCROOT_SNIFF_O) $(DABCROOT_SNIFF_D) $(DABCROOT_SNIFF_DO) $(DABCROOT_SNIFF_DD): DEFINITIONS += $(HTTPDEFEXTRA) 

else

# when using ROOT libRHTTP 

DABCROOT_LIBDEP += $(DABC_ROOTLIBDIR)/libRHTTP.$(DllSuf)

HTTPLIBEXTRA += -lRHTTP

endif

libs:: $(DABCROOT_LIB) $(DABCROOT_MAP)

##### local rules #####

$(DABCINCPATH)/%.h: $(DABCROOTDIR)/%.h
	@echo "Header: $@" 
	@cp -f $< $@

$(DABCINCPATH)/%.h: $(DABCROOTDIRSNIFF)/%.h
	@echo "Header: $@" 
	@cp -f $< $@

$(DABCROOT_LIB): LDFLAGS += $(DABC_ROOTLIBS) $(HTTPLIBEXTRA)

$(DABCROOT_LIB): $(DABCROOT_O) $(DABCROOT_DO)
	$(MakeLib) $(DABCROOT_LIBNAME) "$(DABCROOT_O) $(DABCROOT_DO)" $(TGTDLLPATH)

$(DABCROOT_DS): $(DABCROOT_DICTINCL) $(DABCROOT_LINKDEF)
	$(ROOTCINTDABC) $(DABCROOT_DICTINCL) $(DABCROOT_LINKDEF)

$(DABCROOT_SNIFF_DS): $(DABCROOT_SNIFF_H) $(DABCROOT_SNIFF_LINKDEF)
	$(ROOTCINTDABC) $(DABCROOT_SNIFF_H) $(DABCROOT_SNIFF_LINKDEF)

$(DABCROOT_MAP) : $(DABCROOT_LIB) $(DABCROOT_LINKDEF) $(DABCROOT_SNIFF_LINKDEF) 
	@$(DABC_ROOTBIN)rlibmap -r $(DABCROOT_MAP) -l $(DABCROOT_LIB) -d $(DABCROOT_LIBDEP) -c $(DABCROOT_LINKDEF)
ifeq ($(DABC_ROOT_RHHTP), false)
	@$(DABC_ROOTBIN)rlibmap -r $(DABCROOT_MAP).sniff -l $(DABCROOT_LIB) -d $(DABCROOT_LIBDEP) -c $(DABCROOT_SNIFF_LINKDEF)
	@cat $(DABCROOT_MAP).sniff >> $(DABCROOT_MAP)
	@rm -f $(DABCROOT_MAP).sniff
endif


########### extra roles #############
$(DABCROOT_O) $(DABCROOT_D): INCLUDES += $(DABC_ROOTINCDIR) $(DABCROOTDIR)

$(DABCROOT_DO) $(DABCROOT_DD): INCLUDES += $(DABC_ROOTINCDIR) $(DABCROOTDIR) .

$(DABCROOT_DS): INCLUDES += $(DABCROOTDIRI)

endif

include $(DABCSYS)/config/Makefile.rules

