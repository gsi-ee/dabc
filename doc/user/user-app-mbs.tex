[user/user-app-mbs.tex]
\lsection[MBS event building]{user:mbs}{\mbs\ event building}
\subsection[MBS setup]{\mbs\ setup}
Any \mbs\ system can be controlled by the \dabc\ GUI.
It can run in two operation modes: with \mbs\ event builder or \dabc\ event builder.
The first case means a standard \mbs\ system.

To control a standard \mbs\ nothing has to be done by the user on the \mbs\ side.
\strong{Note}, however that in the user's \mbs\ startup file (typically \verba{startup.scom}) the \verba{m\_daq\_rate} task must be
started as last task (this is probably the case already).
This task calculates the rates. The GUI waits for this task after execution of
the startup file. Because \mbs\ has no states there is no other way to
know when the startup has finished.
Of cause, the \mbs\ itself must have been build with the DIM option (since version v5.1).
Central log file is written as usual.
Optionally one can provide a text file with specifications which parameters
shall appear on screen (see \paref{user:MbsDimconfig}).

For the standard \mbs\ control one needs no \dabc\ installation.
The GUI jar file is sufficient. DIM must be installed.

\lsubsection[MBS control panel]{user:controlMbs}{\mbs\ control panel}
\figpng{user-gui-pan-mbs}{MBS  controller.}{htb}{0}{0.6}
Fig. \paref{fig:user-gui-pan-mbs} shows the panel to be used to control
a standard \mbs.
The values are restored from file {\tt MbsControl.xml} (default, may be saved to other file,
see \paref{user:guiSaveRestore}).
{\small \begin{verbatim}
<?xml version="1.0" encoding="utf-8"?>
<MbsLaunch>
<MbsMaster prompt="MBS Master" value="node-xx" />
<MbsUserPath prompt="MBS User path" value="myMbsDir" />
<MbsSystemPath prompt="MBS system path" value="/mbs/v51" />
<MbsStartup prompt="MBS startup" value="startup.scom"/>
<MbsShutdown prompt="MBS shutdown" value="shutdown.scom"/>
<MbsCommand prompt="Script command" value="whatever command" />
<MbsServers prompt="%Number of needed DIM servers%" value="3" />
</MbsLaunch>
\end{verbatim}
\bdes
\item[MbsMaster]: Lynx node where the \mbs\ prompter is started.
\item[MbsUserPath]: \mbs\ user working directory. The GUI need not to have
access to that filesystem.
\item[MbsSystemPath]:  Path on Lynx where the \mbs\ is installed. GUI needs no access to this path.
\item[MbsStartup]: The user specific \mbs\ startup command procedure, typically \verba{startup.scom},
located on user path.
\item[MbsShutdown]: The user specific \mbs\ shutdown command procedure, typically \verba{shutdown.scom},
located on user path.
\item[MbsCommand]: With \keyw{RET} an \mbs\ command in executed (on current node).
The shell script button executes this string as \verba{rsh} command on master node.
\item[MbsServers]: Number of nodes plus prompter. This information
is minimum for the GUI to know when all \mbs\ nodes are up. The GUI waits until
this number of DIM servers is up and running.
\edes
That file can be created from within the GUI in the \mbs\  controller panel.
Enter all values necessary, and store them. 

\subsubsection[MBS controller buttons]{\mbs\  controller buttons}
\icon{savewin} Save panel settings, see \paref{user:guiSaveRestore}.\\
\icon{connprm}  Execute script \verba{prmstartup.sc} at master node.
Starts prompter, dispatchers and message loggers and waits until they are up.
Trigger the main \keyw{Update}.
A progress panel pops up during that time (see \paref{user:guiProgress}).\\
\icon{conndsp} Execute script \verba{dimstartup.sc} at master node.
Starts dispatcher and message logger for single node \mbs.
Trigger the main \keyw{Update}.\\
\icon{dabcconfig} Configure. Execute user's \mbs\ startup procedure in prompter (dispatcher).
Trigger the main \keyw{Update}.\\
\icon{dabcstart} Start acquisition. Execute \comm{Start acquisition}.\\
\icon{dabcstop} Pause acquisition. Execute \comm{Stop acquisition}.\\
\icon{mbsstop} Halt acquisition. Execute user's \mbs\ shutdown procedure in prompter.
Prompter, dispatcher and message loggers should still be running.\\
\icon{disconn} Shut down all. Execute script \verba{prmshutdown.sc} at master node.
After 2 seconds trigger the main \keyw{Update}.\\
\icon{info} \comm{Show acquisition}. Output in log panel.\\
\icon{controlmbs} Shell script executes command on master node.

\section[DABC event building]{\dabc\ event building}
\subsection[MBS setup]{\mbs\ setup}
When we want to use \dabc\ nodes as event builders, we need a different
setup on the \mbs\ side. We assume that we have more than one
\mbs\ node. Such multi-node system is controlled by an \mbs\ prompter running on one node.
The setup has to be changed such that all nodes run as if they are stand alone.
That means that each node runs the \keyw{Readout} - \keyw{Collector} - \keyw{Transport}
chain. The \dabc\ event builders connect to these transports.
The \mbs\ buffer size should be set to the stream size and the number of buffers per
stream must be set to one.

\subsection[DABC setup]{\dabc\ setup}
On the \dabc\ user working directory we need configuration files.

Summary of parameters:
\bdes
\item[MbsFileName] File name for list mode data file (\keyw{LMD}). Overwritten by command.
\item[MbsFileSizeLimit] File closes when size is reached, and new file opens.
\item[BufferSize] Should match \mbs\ buffer size.
\item[MbsServerKind] \keyw{Transport} | \keyw{Stream}.
\item[MbsServerPort] Port number transport (6000).
\item[MbsServerName] \mbs\ node of transport.
\item[NumInputs] Number of \mbs\ channels for one combiner.
\item[DoFile] Provide output file.
\item[DoServer] Provide server.
\edes
These parameters are used to configure an event generator:
\bdes
\item[NumSubevents]
\item[FirstProcId]
\item[SubeventSize]
\item[Go4Random]
\edes
\index{TODO!dabcsetupfiles}
The following example configuration file {\tt \$DABCSYS/applications/mbs/Combiner.xml} shows how to 
configure one combiner module reading from three \mbs\ transport servers.
Any running program is described by a \keyw{Context}, in this case
named \keyw{Combiner}. The \keyw{Run} specifies the
library, start function and log file name.
We have one module \keyw{Combiner} (could be different name from context) 
with three input ports and two output ports.

Now we can use the combined  controller panel to startup \mbs\ and \dabc.
\lsubsection[Combined DABC and MBS control panel]{user:controlDabcMbs}{Combined \dabc\ and \mbs\ control panel}
\figpng{user-gui-pan-dabcmbs}{Combined DABC and MBS  controller.}{htb}{0}{0.7}
This panel shown in Fig. \paref{fig:user-gui-pan-dabcmbs} is simply a superposition of the single ones.

\subsubsection[Combined DABC and MBS  controller buttons]{Combined \dabc\ and \mbs\  controller buttons}
\icon{savewin} Save panel settings, see \paref{user:guiSaveRestore}.\\
\icon{connprm}  Execute script \verba{dabcstartup.sc} at \dabc\ master node.
Starts DIM servers.
Execute script \verba{prmstartup.sc} at \mbs\ master node.
Starts prompter, dispatchers and message loggers.
Waits for all components.
A progress panel pops up during that time
(see \paref{user:guiProgress}).
If all components are up trigger the main \keyw{Update}.\\
\icon{dabcconfig} Configure. Execute user's \mbs\ startup procedure in prompter.
Executes state transition command \comm{Configure}
on \dabc\ master node and wait for the transition.
All plug-in components are created. Then execute \comm{Enable}.
If all components are up trigger the main \comm{Update}.\\
\icon{dabcstart} Start \mbs\ acquisition, then executes \dabc\ \comm{Start} command.
All components go into running state \keyw{Running}.\\
\icon{dabcstop} Pause acquisition. Execute \mbs\ \comm{stop acquisition}.
Execute \dabc\ \comm{Stop} command.
All components go into standby state \keyw{Ready}.\\
\icon{mbsstop} Halt acquisition. Executes \dabc\ \comm{Halt} command.
This closes all plug-ins. States go into \keyw{Halted}. 
Execute user's \mbs\ shutdown procedure in prompter.
Prompter, dispatcher and message loggers should still be running.
Next must be shut down or configure.
After two seconds trigger the main \keyw{Update}.\\
\icon{disconn} Shut down all. Execute \comm{EXIT} command on all \dabc\ nodes.
Execute script \verba{prmshutdown.sc} at \mbs\ master node.
After two seconds trigger the main \keyw{Update}.\\
\icon{info} \mbs\ \comm{Show acquisition}. Output in log panel.\\
\icon{controlmbs} Shell script for \mbs\ master node.\\
\icon{controldabc} Shell script for \dabc\ master node.

\subsection[MBS command panel]{\mbs\ command panel}
\figpng{user-gui-pan-cmd-mbs}{Command panel.}{htb}{0}{0.9}
Fig. \paref{fig:user-gui-pan-cmd-mbs} shows
on the left side the command tree. Double click (or \keyw{RETURN}) on a command
executes the command. The top tree level is the executing \mbs\ task,
below that are the commands, and the master node (prompter node) is the only node
below each command. However,
command is sent to the prompter node, but executed on the current node 
which is displayed in the info panel
(see Fig. \paref{fig:user-gui-pan-cmd-mbs2}).
Click on a command opens at the right side the argument panel.
Entering argument values and \keyw{RETURN} executes the command.
\figpng{user-gui-pan-cmd-mbs1}{Info and command panel.}{htb}{0}{0.9}
Only the \mbs\ commands of the running tasks are shown. 
Fig. \paref{fig:user-gui-pan-cmd-mbs1} shows that only dispatcher and prompter are up
and therefore only their commands are seen.
\figpng{user-gui-pan-cmd-mbs2}{Info and command panel.}{htb}{0}{0.9}
Fig. \paref{fig:user-gui-pan-cmd-mbs2} shows in addition the commands
of util and transport after configuration.
\section[MBS DIM parameters]{\mbs\ DIM parameters}
\subsection[MBS states]{\mbs\ states}
\bdes
\item[Acquisition/State] \keyw{Running} | \keyw{Stopped} 
\item[BuildingMode/State] \keyw{Delayed} | \keyw{Immediate}
\item[EventBuilding/State] \keyw{Working} | \keyw{Suspended}
\item[FileOpen/State] \keyw{File open} | \keyw{File closed}
\item[RunMode/State] \keyw{DABC connected} | \keyw{MBS to DABC} | \keyw{Transport client} | \keyw{MBS standalone}
\item[SpillOn/State] \keyw{Spill ON} | \keyw{Spill OFF}
\item[Trigger/State] \keyw{Master} | \keyw{Slave}
\edes
\subsection[MBS rates]{\mbs\ rates}
\bdes
\item[MSG/DataRateKb] KByte/s
\item[MSG/DataTrendKb] KBytes/s as trend
\item[MSG/EventRate] Events/s
\item[MSG/EventTrend] Events/s as trend
\item[MSG/StreamRateKb] Stream server Kbyte/s
\item[MSG/StreamTrendKb] Stream server Kbyte/s as trend
\item[MSG/FileFilled] File filled in percent
\item[MSG/StreamsFull] Number of full streams in percent
\edes
\subsection[MBS infos]{\mbs\ infos}
Shown in info window.
\bdes
\item[MSG/eFile] Name of file.
\item[MSG/ePerform] Events, MBytes, Events/s and MBytes/s.
\item[MSG/eSetup] Name of setup file loaded.
\item[PRM/Current] Current command execution node (master node only).
\item[PRM/NodeList] List of nodes (master node only).
\edes
\subsection[MBS tasks]{\mbs\ tasks}
Task list is shown in info window (name slightly different).

 Dispatch 
 MsgLog 
 ReadMeb 
 Collector 
 Transport 
 EventServ 
 Util 
 ReadCam 
 EsoneServ 
 StreamServ 
 Histogram 
 Prompt 
 Rate 
 SMI 
 Sender 
 Receiver 
 AsynchReceiver 
 Rising 
 TimeOrder 
 VmeServ 

\subsection[MBS text]{\mbs\ text}
\bdes
\item[MSG/GuiNode] Node where GUI runs
\item[MSG/Date] Date as written in file header
\item[MSG/Run] Run ID  as written in file header
\item[MSG/Experiment] Experiment as written in file header
\item[MSG/User] Lynx user name as written in file header
\item[MSG/Platform] CPU platform
\edes
\subsection[MBS numbers]{\mbs\ numbers}
\bdes
\item[MSG/BufferSize]
\item[MSG/Buffers] collected so far.
\item[MSG/Events] collected so far.
\item[MSG/FileMbytes] written in file.
\item[MSG/FlushTime]
\item[MSG/MBytes] collected so far.
\item[MSG/StreamKeep] 
\item[MSG/StreamMbytes]
\item[MSG/StreamScale]
\item[MSG/StreamSync]
\edes
\section{Working directories}
\lsubsection[MBS configuration of DIM]{user:MbsDimconfig}{\mbs\ configuration of DIM}
Optional file \verba{.guirc} in the \mbs\ working directory
specifies which rate meters and states shall appear
in the GUI. Upper limits of the rate meters can be specified.
This file can be copied from \$MBSROOT/set. Only the
parameters which are in this file are optional.
{\small {\begin{verbatim}
## This file controls the rate meter and state appearance.
## File name must be .guirc and in the MBS working directory.
## The value numbers are the maximum values for rate meters
## Colons only if value is specified!
## Node names must be uppercase, * wildcards all
## RunMode shows if MBS is set into DABC event builder mode 
## and client is connected.

##========= All nodes:
##---- Rates:
* EventRate     : 10000.
* EventTrend    : 10000.
* DataRateKb    : 16000.
* DataTrendKb   : 16000.
* StreamRateKb  : 16000.
* StreamTrendKb : 16000.
# ++ File filling status in percent, typically only on one node (transport)
#* FileFilled   :   100.
* StreamsFull   :   100.

##---- States:
# ++ Delayed or immediate event building:
* BuildingMode
# ++ Current eventbuilding running or suspended:
* EventBuilding
# ++ Running mode, stand alone or DABC:
* RunMode
# ++ Shows spill signal:
#* SpillOn
# ++ Shows if file is open, typically only on one node (transport)
#* FileOpen
#* Trigger

##======== Node XXX
#XXX EventRate   : 10000.
#XXX DataRateKb  : 16000.
#XXX RunMode
#XXX FileOpen
#XXX FileFilled  :   100.
#XXX SpillOn
#XXX EventTrend  : 10000.
#XXX DataTrendKb : 16000.
\end{verbatim}
}

