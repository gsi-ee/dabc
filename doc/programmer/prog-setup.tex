[programmer/prog-setup.tex]
\section{Setting up system}

Configuration parameters for mostly all objects, created in dabc, 
can be placed in xml file. 



\subsection{Simple example}

Lets consider simple example of configuration file:

\begin{verbatim}

<?xml version="1.0"?>
<dabc version="1">
  <Context name="Generator">
    <Run>
      <lib value="libDabcMbs.so"/>
      <func value="StartMbsGenerator"/>
    </Run>
    <Module name="Generator">
       <Port name="Output">
          <OutputQueueSize value="5"/>
          <MbsServerPort value="6000"/>
       </Port>
    </Module>
  </Context>
</dabc>

\end{verbatim}

This is an example of xml file for mbs generator, which produces 
mbs events and provides them to mbs transport server. Other application
(dabc or Go4) can connect to that server and read generated mbs events.

\subsection{Basic syntax}

DABC configuration file should always contain <dabc> as root node. 
Inside <dabc> node one or several <Context> nodes should exists.
Each <Context> node corresponds to independent application context, which runs as
independent executable. 
Optionally <dabc> node can has <Variables> and <Defaults> nodes, which are described further. 

\subsection{Context}

<Context> node can has two optional attributes:
\bdes
\item["host"] host name, where executable should runs, default is localhost
\item["name"] application (manager), default is host name.
\edes

Inside <Context> node configuration parameters for modules, devices, memory pools are stored.
In example file one sees several parameters for output port of generator module.  

\subsection{Run parameters}

Usually <Context> node has <Run> subnode, where user defines different parameters, relevant to start
application:

\bdes
\item[lib] library name, which should be loaded. Several libraries names can be specified.
\item[func] function name which should be called to create modules. 
It is alternative to writing subclass of \class{Application} and instantiating it.
\item[port] ssh port number of remote host
\item[user] account name to be used for ssh (login without password should be possible)
\item[init] init script, which should be called before dabc application starts
\item[test] test script, which is called when test sequence is run by run.sh script
\item[timeout] ssh timeout 
\item[debugger] argument to run debugger. Value should be like "gdb -x run.txt --args", where file run.txt should contain commands "r bt q".
\item[workdir] directory where dabc application should start
\item[debuglevel] level of debug output on console, default 1
\item[logfile] filename for log output, default none  
\item[loglevel] level of log output to file, default 2 
\edes


\subsection{Variables}

In root <dabc> node one can insert <Variables> node, which may contain 
definition of one or several variables. Once defined, 
such variables can be used in any place of configuration file to set parameters values.
In this case syntax to set parameter is:

\begin{verbatim}
    <ParameterName value="${VariableName}"/>
\end{verbatim}

It is allowed to combine variable with text or other variable, 
but neither arithmetic nor string operations are supported. 

Using variables, one can modify example in following way:

\begin{verbatim}

<?xml version="1.0"?>
<dabc version="1">
  <Variables>
    <myname value="Generator"/> 
    <myport value="6010"/> 
  </Variables>
  <Context name="Mgr${myname}">
    <Run>
      <lib value="libDabcMbs.so"/>
      <func value="StartMbsGenerator"/>
    </Run>
    <Module name="${myname}">
       <Port name="Output">
          <OutputQueueSize value="5"/>
          <MbsServerPort value="${myport}"/>
       </Port>
    </Module>
  </Context>
</dabc>

\end{verbatim}

Here context name and module name are set via myname variable and mbs server 
socket port is set via myport variable.

There are several variables, which are defined by configuration system:

\bbul
\item DABCSYS - top directory of dabc installation
\item DABCUSERDIR - user-specified directory
\item DABCWORKDIR - current working directory
\item DABCNUMNODES - number of <Context> nodes in configuration files
\item DABCNODEID - sequence number of current <Context> node in configuration file 
\ebul

Any environment variable can also be used as variable to set parameter values. 


\subsection{Default values}

There are situations, when one need to set same value to several similar parameters,
for instance same output queue length for all output ports in the module. One possible way
is to use variables (as described before) and set parameter value via variable. 
Disadvantage of such approach that one should expand xml files and in case 
of big number of ports xml file will be very long and unreadable.

Another possibility to set several parameters at once - create <dabc/Defaults> node and
specify cast rule, using "*" or "?" symbols like that: 

\begin{verbatim}

<?xml version="1.0"?>
<dabc version="1">
  <Variables>
    <myname value="Generator"/> 
    <myport value="6010"/> 
  </Variables>

  <Context name="Mgr${myname}">
    <Run>
      <lib value="libDabcMbs.so"/>
      <func value="StartMbsGenerator"/>
    </Run>
    <Module name="${myname}">
       <Port name="Output">
          <MbsServerPort value="${myport}"/>
       </Port>
    </Module>
  </Context>
  <Defualts>
    <Module name="*">
       <Port name="Output*">
          <OutputQueueSize value="5"/>
       </Port>
    </Module>
  </Defualts>
</dabc>

\end{verbatim}

In this case for all ports, which names are started with string "Output" from any module,
output queue length will be 5. 

In form, as it is specified in example, such multicast rule will be applied for 
all contexts from configuration file means by such rule we set output queue length 
for all modules on all nodes. This allow us to create compact xml files for big multi-nodes configuration.   


\subsection{Configuration priorities}

Setting parameter values via xml file not the only possibility for system configuration. 
Usually parameter has default value, which is specified at the time when parameter is created.
One also can supply some configuration parameters to the command, when module or device or transport is created.

Here possibilities to set parameter value listed with decreased priority:

\bbul
\item Command argument. It has the highest priority in all cases and allows programmer to
overwrite any configuration parameters which user may define in configuration file
\item Parameter value from appropriate <Context> node. In this case names of parameter and all its parents  
should exactly match to names which are specified in xml file. No any kind of cast is supported.  
\item Parameter value from <Defaults> node. Parameter name and names of at least one parent should match to multicast rules.
If there is several matches exists match with maximal number of parent matches will be preferred.
For instance node <Defualts/Context/Module/Port/OutputQueueSize> will be preferable rather than
<Defualts/Port/OutputQueueSize>. 
\item Default parameter value.
\ebul
    

